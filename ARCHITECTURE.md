# Chain-of-Thought æ¶æ§‹åœ–

## æ•´é«”æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Flask ä¼ºæœå™¨                          â”‚
â”‚                    (server.py)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ POST /analyze
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸»åˆ†æå…¥å£                                â”‚
â”‚              analyze_deep(html_text)                       â”‚
â”‚              (analyzer.py)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                 â†“
    [å‰ç½®è™•ç†]        [å·¥å…·èª¿ç”¨]
    - æå–å…§æ–‡        - Planner è¦åŠƒ
    - æå– URL        - åŸ·è¡Œå·¥å…·
    - è¨ˆç®—è¦å‰‡åˆ†æ•¸    - æ”¶é›† Evidence

    [å…±åŒä¸Šä¸‹æ–‡]
    â”œâ”€ visible_text
    â”œâ”€ urls
    â”œâ”€ evidence
    â”œâ”€ rule_score
    â””â”€ hard_flag
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CoT ç¬¬ä¸€æ­¥ï¼šæ€è€ƒéç¨‹             â”‚
â”‚  (build_cot_thinking_chain())      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Model: qwen3:8b                 â”‚
â”‚ â€¢ Temperature: 0.5                â”‚
â”‚ â€¢ Prompt: è¦æ±‚é€æ­¥æ¨ç†             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Input:                            â”‚
â”‚   - visible_text (å…§æ–‡)           â”‚
â”‚   - urls (ç¶²å€)                   â”‚
â”‚   - evidence (å·¥å…·çµæœ)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Output: cot_thinking (è‡ªç”±æ–‡å­—)    â”‚
â”‚ âœ“ æ¨ç†æ¸…æ™°æ˜ç¢º                    â”‚
â”‚ âœ“ è§£é‡‹å„å€‹åˆ¤æ–·æ­¥é©Ÿ                â”‚
â”‚ âœ“ è¨˜éŒ„åœ¨æ—¥èªŒä¸­                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ (æ¨ç†éç¨‹)
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CoT ç¬¬äºŒæ­¥ï¼šæœ€çµ‚åˆ¤æ–·             â”‚
â”‚  (build_analysis_chain())         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Model: qwen3:8b                 â”‚
â”‚ â€¢ Temperature: 0                  â”‚
â”‚ â€¢ Prompt: åš´æ ¼ JSON è¦æ±‚           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Input:                            â”‚
â”‚   - visible_text                  â”‚
â”‚   - urls                          â”‚
â”‚   - evidence                      â”‚
â”‚   - cot_thinking (æ¨ç†çµæœ) â† æ–°å¢ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Output: JSON                      â”‚
â”‚ {                                 â”‚
â”‚   "is_potential_phishing": bool  â”‚
â”‚   "risk_level": string           â”‚
â”‚   "explanation": [...]           â”‚
â”‚   "confidence": int              â”‚
â”‚ }                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ (JSON åˆ¤æ–·)
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    è¦å‰‡è¦†è“‹ & èåˆ                 â”‚
â”‚    (rule_score é‚è¼¯å„ªå…ˆ)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è‹¥ hard_flag = true â†’ å¼·åˆ¶ high  â”‚
â”‚ â€¢ è‹¥ score >= 6 â†’ æå‡ç‚º high      â”‚
â”‚ â€¢ è‹¥å¯ç–‘åŸŸå â†’ æå‡ä¿¡å¿ƒåº¦          â”‚
â”‚ â€¢ èåˆ LLM åˆ¤æ–·èˆ‡è¦å‰‡              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æœ€çµ‚çµæœ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                 â”‚
â”‚   "is_potential_phishing": bool  â”‚
â”‚   "risk_level": string           â”‚
â”‚   "confidence": int              â”‚
â”‚   "explanation": [...]           â”‚
â”‚   "evidence": { ... },           â”‚
â”‚   "cot_thinking": string,   â† æ–°  â”‚
â”‚   "is_blacklisted": bool,        â”‚
â”‚   "blacklist_source": string,    â”‚
â”‚   "elapsed_time": float          â”‚
â”‚ }                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
        [è¿”å›çµ¦å‰ç«¯/å®¢æˆ¶ç«¯]
        å¯é¸é¡¯ç¤º cot_thinking
        ä¾›èª¿è©¦æˆ–æ•™è‚²ä¹‹ç”¨
```

---

## æ–°èˆŠæµç¨‹å°æ¯”

### èˆŠç‰ˆæœ¬æµç¨‹ï¼ˆå–®æ­¥ï¼‰

```
è¼¸å…¥ HTML
    â†“
æå–ç‰¹å¾µ (å…§æ–‡, URL, è­‰æ“š)
    â†“
LLM åˆ†æ (temperature=0, ç›´æ¥ JSON)
    â†“
è¦å‰‡è¦†è“‹
    â†“
å›å‚³ JSON çµæœ
```

**å•é¡Œï¼š**
- âŒ ç„¡æ³•çœ‹åˆ°æ¨ç†éç¨‹
- âŒ LLM å¯èƒ½ã€Œå€‰ä¿ƒä¸‹çµè«–ã€
- âŒ é›£ä»¥é©—è­‰æˆ–æ”¹é€²

### æ–°ç‰ˆæœ¬æµç¨‹ï¼ˆCoTï¼‰

```
è¼¸å…¥ HTML
    â†“
æå–ç‰¹å¾µ (å…§æ–‡, URL, è­‰æ“š)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥é©Ÿ 1ï¼šLLM è‡ªç”±æ€è€ƒ       â”‚
â”‚ (temperature=0.5)         â”‚
â”‚ â†’ æ¨ç†éç¨‹ (æ–‡å­—èªªæ˜)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥é©Ÿ 2ï¼šLLM æœ€çµ‚åˆ¤æ–·       â”‚
â”‚ (temperature=0)           â”‚
â”‚ + è€ƒæ…®æ­¥é©Ÿ 1 çš„çµæœ        â”‚
â”‚ â†’ JSON çµè«–               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¦å‰‡è¦†è“‹
    â†“
å›å‚³ JSON + æ¨ç†éç¨‹
```

**å„ªå‹¢ï¼š**
- âœ… æ¨ç†éç¨‹å¯è¦‹ï¼ˆå¯è§£é‡‹æ€§ï¼‰
- âœ… LLM æœ‰æ›´å¤šä¸Šä¸‹æ–‡ï¼ˆæº–ç¢ºåº¦â†‘ï¼‰
- âœ… ä¾¿æ–¼é©—è­‰å’Œæ”¹é€²

---

## æ–‡ä»¶ä¿®æ”¹æ¸…å–®

### ä¿®æ”¹çš„æª”æ¡ˆ

#### `analyzer.py`
```diff
+ def build_cot_thinking_chain():
+     """ç¬¬ä¸€æ­¥ï¼šè‡ªç”±æ€è€ƒ"""
+     llm = ChatOllama(model=MODEL_NAME, temperature=0.5)
+     # ...
+
+ def build_analysis_chain():
+     """ç¬¬äºŒæ­¥ï¼šæœ€çµ‚åˆ¤æ–·ï¼ˆæ”¹é€²ç‰ˆï¼ŒåŠ å…¥ cot_thinkingï¼‰"""
+     # ... æ–°å¢ cot_thinking åƒæ•¸
-     resp = chain.invoke(...)
+     # Step 1: CoT Thinking
+     cot_thinking = ...
+     # Step 2: Analysis
+     resp = chain.invoke(..., "cot_thinking": cot_thinking)

  def analyze_deep(html_text: str) -> dict:
      # ... å‰ç½®é‚è¼¯
+     # STEP 1: Chain-of-Thought (Thinking)
+     cot_thinking = ""
+     try:
+         cot_chain = build_cot_thinking_chain()
+         cot_resp = cot_chain.invoke(...)
+         cot_thinking = ...
+     except:
+         cot_thinking = "æ¨ç†éç¨‹å‡ºéŒ¯"

+     # STEP 2: Final Analysis (JSON)
+     chain = build_analysis_chain()
+     resp = chain.invoke(..., "cot_thinking": cot_thinking)

      return {
          ...,
+         "cot_thinking": cot_thinking[:800],
          ...
      }
```

### æ–°å¢çš„æª”æ¡ˆ

#### `cot_demo.py`
- æ¼”ç¤º CoT åŠŸèƒ½çš„ç¨ç«‹è…³æœ¬
- åŒ…å«å…©å€‹æ¸¬è©¦æ¡ˆä¾‹ï¼ˆé‡£é­š + æ­£å¸¸ï¼‰
- è¼¸å‡ºæ¨ç†éç¨‹å’Œ JSON çµæœ

#### `COT_IMPLEMENTATION.md`
- è©³ç´°çš„å¯¦ç¾èªªæ˜
- å‡½æ•¸ç°½åå’Œåƒæ•¸èªªæ˜
- æ—¥èªŒçµæ§‹å’Œèª¿è©¦æŠ€å·§

#### `CoT_QUICK_REFERENCE.md`
- å¿«é€Ÿåƒè€ƒæŒ‡å—
- API è®ŠåŒ–èªªæ˜
- é…ç½®èª¿æ•´æ–¹æ³•
- å¸¸è¦‹å•é¡Œè§£ç­”

---

## æº«åº¦åƒæ•¸èªªæ˜

### Temperature çš„ä½œç”¨

```
Temperature ä½ (0-0.2)          Temperature é«˜ (0.5-1.0)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç¢ºå®šæ€§å¼· â”‚                      â”‚ å¤šæ¨£æ€§å¼·
å°ˆæ³¨èšç„¦ â”‚                      â”‚ æ¢ç´¢æ€§å¼·
é‡è¤‡æ€§é«˜ â”‚                      â”‚ å‰µæ„æ€§å¼·
é©åˆæ¨è«– â”‚                      â”‚ é©åˆé ­è…¦é¢¨æš´
```

### æœ¬å¯¦ç¾çš„é¸æ“‡

| éšæ®µ | Temperature | ç”¨é€” | å‚™è¨» |
|------|-----------|------|------|
| CoT æ€è€ƒ | 0.5 | æ¢ç´¢å¼æ¨ç† | å…è¨±å¤šè§’åº¦åˆ†æ |
| æœ€çµ‚åˆ¤æ–· | 0 | ç¢ºå®šæ€§è¼¸å‡º | ä¿è­‰ JSON æ ¼å¼ |
| è¦å‰‡ç³»çµ± | N/A | è¼”åŠ©æ±ºç­– | å„ªå…ˆç´šæœ€é«˜ |

---

## æ€§èƒ½é æœŸ

### è³‡æºæ¶ˆè€—

```
CPU:     Planner å¤šæ¬¡èª¿ç”¨ â†’ å¢åŠ ç•¥å¾®CPU load
è¨˜æ†¶é«”:   æ¨ç†éç¨‹ä¿å­˜åœ¨è¨˜æ†¶é«” â†’ å¢åŠ  ~50-100MB
å»¶é²:     +1-1.5 ç§’ï¼ˆé¡å¤– LLM èª¿ç”¨ï¼‰
```

### ç²¾åº¦æ”¹å–„

```
æº–ç¢ºåº¦æå‡:  ~5-10% (å–æ±ºæ–¼æ¨¡å‹å“è³ª)
å‡æ­£ç‡:      â†“ (è¦å‰‡ + CoT å”åŒ)
çœŸé™½ç‡:      â†‘ (æ›´å…¨é¢çš„åˆ†æ)
```

---

## æ—¥èªŒè¨˜éŒ„ç¤ºä¾‹

### æ–°å¢çš„æ—¥èªŒæ¢ç›®

```jsonl
{"time": "2024-...", "phase": "cot_thinking", "cot_output": "è§€å¯Ÿ1: ...è§€å¯Ÿ2: ..."}
{"time": "2024-...", "phase": "final", "cot_thinking": "...", "final": {...}}
```

### æŸ¥çœ‹æ—¥èªŒ

```bash
# å³æ™‚æŸ¥çœ‹
tail -f planner_tool_log.jsonl

# éæ¿¾ CoT ç›¸é—œ
grep "cot" planner_tool_log.jsonl

# çµ±è¨ˆåˆ†æ
jq '.phase' planner_tool_log.jsonl | sort | uniq -c
```

---

## éƒ¨ç½²å»ºè­°

### ç”Ÿç”¢ç’°å¢ƒæª¢æŸ¥æ¸…å–®

- [ ] ç¢ºä¿ Ollama æ¨¡å‹å·²è¼‰å…¥ (`qwen3:8b`)
- [ ] æ¸¬è©¦ `/analyze` API ç«¯é»
- [ ] é©—è­‰ `cot_thinking` åœ¨å›æ‡‰ä¸­
- [ ] æª¢æŸ¥æ—¥èªŒè¨˜éŒ„æ ¼å¼
- [ ] ç›£æ¸¬è™•ç†æ™‚é–“ï¼ˆæ‡‰ < 5 ç§’ï¼‰
- [ ] é©—è­‰ JSON æ ¼å¼æ­£ç¢ºæ€§

### ç›£æ¸¬æŒ‡æ¨™

```
â€¢ å¹³å‡æ‡‰ç­”æ™‚é–“: 2.5-3.5 ç§’
â€¢ æº–ç¢ºåº¦: > 80%
â€¢ æ—¥èªŒå¤§å°: ~1MB/1000 è«‹æ±‚
â€¢ è¨˜æ†¶é«”ç©©å®š: < 500MB
```

---

## ç‰ˆæœ¬æ§åˆ¶

```
Commit: 49881a6
Message: feat: Implement Chain-of-Thought (CoT) analysis
Files Changed: 4
Insertions: 610+
Deletions: 6-
```

---

## æ¥ä¸‹ä¾†çš„å„ªåŒ–æ–¹å‘

1. **å¿«å–æ€è€ƒçµæœ**
   - å°ç›¸åŒè¼¸å…¥å¿«å– CoT çµæœ
   - åŠ å¿«é‡è¤‡æŸ¥è©¢

2. **æ¢ä»¶ CoT**
   - æ˜ç¢ºé»‘åå–® â†’ è·³é CoTï¼Œç›´æ¥åˆ¤å®š
   - ç¯€çœè™•ç†æ™‚é–“

3. **åˆ†ç´š CoT**
   - ä½é¢¨éšªï¼šç°¡åŒ–æ€è€ƒ
   - é«˜é¢¨éšªï¼šè©³ç´°æ€è€ƒ

4. **æ¨¡å‹å¾®èª¿**
   - ç”¨å¯¦éš›æ—¥èªŒè³‡æ–™å¾®èª¿æ¨¡å‹
   - æå‡æº–ç¢ºåº¦

---

## ç¸½çµ

| é …ç›® | ç‹€æ…‹ | èªªæ˜ |
|------|------|------|
| æ ¸å¿ƒå¯¦ç¾ | âœ… | å…©æ­¥åˆ†æå·²æ•´åˆ |
| API ç›¸å®¹æ€§ | âœ… | å‘å¾Œç›¸å®¹ï¼Œç„¡ç ´å£æ€§è®Šæ›´ |
| æ–‡æª” | âœ… | å®Œæ•´çš„æ–‡æª”å’Œç¯„ä¾‹ |
| æ¼”ç¤º | âœ… | cot_demo.py å¯ç”¨ |
| æ¸¬è©¦ | âœ… | èªæ³•æª¢æŸ¥é€šé |
| Git | âœ… | å·²æäº¤ä¸¦æ¨é€ |

**å‡†å‚™ä¸Šç·šï¼ğŸš€**
